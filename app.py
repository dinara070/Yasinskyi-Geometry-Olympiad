import streamlit as st
import requests
from bs4 import BeautifulSoup
from urllib.parse import urljoin, unquote
import io
import zipfile
import pandas as pd

# --- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ ---
st.set_page_config(
    page_title="–ì–µ–æ–º–µ—Ç—Ä–∏—á–Ω–∞ –æ–ª—ñ–º–ø—ñ–∞–¥–∞ —ñ–º. –í. –Ø—Å—ñ–Ω—Å—å–∫–æ–≥–æ",
    page_icon="üìê",
    layout="wide"
)

# --- –ë–æ–∫–æ–≤–µ –º–µ–Ω—é (–ù–∞–≤—ñ–≥–∞—Ü—ñ—è) ---
st.sidebar.title("–ù–∞–≤—ñ–≥–∞—Ü—ñ—è")
page = st.sidebar.radio(
    "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Ä–æ–∑–¥—ñ–ª—É:",
    ["–ü—Ä–æ –æ–ª—ñ–º–ø—ñ–∞–¥—É", "–û–ª—ñ–º–ø—ñ–∞–¥–∞ 2025", "–ó–∞–¥–∞—á—ñ (–ê—Ä—Ö—ñ–≤)", "–Ü—Å—Ç–æ—Ä—ñ—è", "–ö–æ–Ω—Ç–∞–∫—Ç–∏"]
)

st.sidebar.markdown("---")
st.sidebar.info("–†–æ–∑—Ä–æ–±–ª–µ–Ω–æ –Ω–∞ Python + Streamlit")

# --- –õ–æ–≥—ñ–∫–∞ —Å—Ç–æ—Ä—ñ–Ω–æ–∫ ---

if page == "–ü—Ä–æ –æ–ª—ñ–º–ø—ñ–∞–¥—É":
    st.title("–ì–µ–æ–º–µ—Ç—Ä–∏—á–Ω–∞ –æ–ª—ñ–º–ø—ñ–∞–¥–∞ —ñ–º–µ–Ω—ñ –í'—è—á–µ—Å–ª–∞–≤–∞ –Ø—Å—ñ–Ω—Å—å–∫–æ–≥–æ")
    st.image("https://yasinskyi-geometry-olympiad.com/images/main-logo.png", use_container_width=True) # –°–ø—Ä–æ–±—É—î–º–æ –ø—ñ–¥—Ç—è–≥–Ω—É—Ç–∏ –ª–æ–≥–æ, —è–∫—â–æ —î
    
    st.markdown("""
    ### –ü—Ä–æ –∑–º–∞–≥–∞–Ω–Ω—è
    **–ì–µ–æ–º–µ—Ç—Ä–∏—á–Ω–∞ –æ–ª—ñ–º–ø—ñ–∞–¥–∞ —ñ–º–µ–Ω—ñ –í'—è—á–µ—Å–ª–∞–≤–∞ –Ø—Å—ñ–Ω—Å—å–∫–æ–≥–æ** ‚Äî —Ü–µ —â–æ—Ä—ñ—á–Ω–µ –∑–º–∞–≥–∞–Ω–Ω—è, —è–∫–µ –æ–±'—î–¥–Ω—É—î –ø–æ—Ü—ñ–Ω–æ–≤—É–≤–∞—á—ñ–≤ –≥–µ–æ–º–µ—Ç—Ä–∏—á–Ω–∏—Ö –∑–∞–¥–∞—á. 
    –í–ø–µ—Ä—à–µ –≤–æ–Ω–∞ –±—É–ª–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ —É **2017 —Ä–æ—Ü—ñ**.
    
    –û–ª—ñ–º–ø—ñ–∞–¥–∞ –Ω–∞–∑–≤–∞–Ω–∞ –Ω–∞ —á–µ—Å—Ç—å **–í'—è—á–µ—Å–ª–∞–≤–∞ –Ø—Å—ñ–Ω—Å—å–∫–æ–≥–æ** ‚Äî –≤—ñ–¥–æ–º–æ–≥–æ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ–≥–æ –≤—á–∏—Ç–µ–ª—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏, –º–∞–π—Å—Ç—Ä–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫—Ä–∞—Å–∏–≤–∏—Ö –æ–ª—ñ–º–ø—ñ–∞–¥–Ω–∏—Ö –∑–∞–¥–∞—á.

    ### –ú–µ—Ç–∞
    –û–ª—ñ–º–ø—ñ–∞–¥–∞ –Ω–∞–¥–∞—î —á—É–¥–æ–≤—É –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å–≤–æ—ó –Ω–∞–≤–∏—á–∫–∏ —Ä–æ–∑–≤'—è–∑—É–≤–∞–Ω–Ω—è –æ–ª—ñ–º–ø—ñ–∞–¥–Ω–∏—Ö –≥–µ–æ–º–µ—Ç—Ä–∏—á–Ω–∏—Ö –∑–∞–¥–∞—á. 
    –°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å –∑–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–∏—Ö –∑–∞–¥–∞—á –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Ä—ñ–≤–Ω—é –Ω–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏—Ö –æ–ª—ñ–º–ø—ñ–∞–¥.
    """)

elif page == "–û–ª—ñ–º–ø—ñ–∞–¥–∞ 2025":
    st.title("üèÜ –û–ª—ñ–º–ø—ñ–∞–¥–∞ 2025")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.info("üìÖ **–ö–æ–ª–∏:** –õ–∏—Å—Ç–æ–ø–∞–¥ 2025 —Ä–æ–∫—É")
        st.warning("üìç **–§–æ—Ä–º–∞—Ç:** –û–Ω–ª–∞–π–Ω")
    
    with col2:
        st.success("üë• **–£—á–∞—Å–Ω–∏–∫–∏:** –£—á–Ω—ñ 8-11 –∫–ª–∞—Å—ñ–≤")
        st.error("‚è≥ **–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å:** 4 –≥–æ–¥–∏–Ω–∏")

    st.markdown("---")
    st.subheader("–ü—Ä–∞–≤–∏–ª–∞ —É—á–∞—Å—Ç—ñ")
    st.write("""
    1. –ü—Ä–æ–ø–æ–Ω—É—î—Ç—å—Å—è –¥–ª—è —Ä–æ–∑–≤'—è–∑–∞–Ω–Ω—è **5 –≥–µ–æ–º–µ—Ç—Ä–∏—á–Ω–∏—Ö –∑–∞–¥–∞—á**.
    2. –ö–æ–∂–Ω–∞ –∑–∞–¥–∞—á–∞ –æ—Ü—ñ–Ω—é—î—Ç—å—Å—è –≤—ñ–¥ **0 –¥–æ 7 –±–∞–ª—ñ–≤**.
    3. –ó–∞–≤–¥–∞–Ω–Ω—è —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω—ñ –Ω–∞ —É—á–Ω—ñ–≤ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö —á–æ—Ç–∏—Ä—å–æ—Ö –∫–ª–∞—Å—ñ–≤ —à–∫–æ–ª–∏.
    4. **–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è:** –ü–æ–ø–µ—Ä–µ–¥–Ω—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–∞. –§–æ—Ä–º–∞ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Ä–æ–∑–≤'—è–∑–∫—ñ–≤ –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –≤ –¥–µ–Ω—å –æ–ª—ñ–º–ø—ñ–∞–¥–∏.
    """)

elif page == "–ó–∞–¥–∞—á—ñ (–ê—Ä—Ö—ñ–≤)":
    st.title("üìö –ê—Ä—Ö—ñ–≤ –∑–∞–¥–∞—á —Ç–∞ —Ä–æ–∑–≤'—è–∑–∫—ñ–≤")
    st.write("–¢—É—Ç –≤–∏ –º–æ–∂–µ—Ç–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —É–º–æ–≤–∏ —Ç–∞ —Ä–æ–∑–≤'—è–∑–∫–∏ –≤—Å—ñ—Ö –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –æ–ª—ñ–º–ø—ñ–∞–¥ –æ–¥–Ω–∏–º –∞—Ä—Ö—ñ–≤–æ–º.")

    # --- –ö–æ–¥ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á–∞ ---
    if st.button("üîç –ó–Ω–∞–π—Ç–∏ —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—Å—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ (ZIP)"):
        status_text = st.empty()
        progress_bar = st.progress(0)
        TARGET_URL = "https://yasinskyi-geometry-olympiad.com/"
        
        try:
            status_text.info(f"–ó'—î–¥–Ω–∞–Ω–Ω—è –∑ {TARGET_URL}...")
            headers = {"User-Agent": "Mozilla/5.0"}
            response = requests.get(TARGET_URL, headers=headers)
            response.raise_for_status()
            
            soup = BeautifulSoup(response.text, 'html.parser')
            links = soup.find_all('a', href=True)
            
            pdf_links = []
            for link in links:
                href = link['href']
                if href.lower().endswith('.pdf'):
                    full_url = urljoin(TARGET_URL, href)
                    pdf_links.append(full_url)
            
            if not pdf_links:
                status_text.warning("PDF-—Ñ–∞–π–ª—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.")
            else:
                status_text.success(f"–ó–Ω–∞–π–¥–µ–Ω–æ {len(pdf_links)} —Ñ–∞–π–ª—ñ–≤. –§–æ—Ä–º—É–≤–∞–Ω–Ω—è –∞—Ä—Ö—ñ–≤—É...")
                zip_buffer = io.BytesIO()
                
                with zipfile.ZipFile(zip_buffer, "w") as zf:
                    for i, file_url in enumerate(pdf_links):
                        file_name = unquote(file_url.split('/')[-1])
                        try:
                            f_resp = requests.get(file_url, headers=headers)
                            zf.writestr(file_name, f_resp.content)
                        except:
                            pass
                        progress_bar.progress((i + 1) / len(pdf_links))

                zip_buffer.seek(0)
                status_text.success("‚úÖ –ì–æ—Ç–æ–≤–æ!")
                
                st.download_button(
                    label="üì• –°–∫–∞—á–∞—Ç–∏ yasinskyi_tasks.zip",
                    data=zip_buffer,
                    file_name="yasinskyi_tasks.zip",
                    mime="application/zip"
                )
        except Exception as e:
            status_text.error(f"–ü–æ–º–∏–ª–∫–∞: {e}")

elif page == "–Ü—Å—Ç–æ—Ä—ñ—è":
    st.title("üìä –Ü—Å—Ç–æ—Ä—ñ—è —Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
    st.write("–î–∏–Ω–∞–º—ñ–∫–∞ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —É—á–∞—Å–Ω–∏–∫—ñ–≤ –∑–∞ —Ä–æ–∫–∞–º–∏:")

    # –°—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω—ñ –¥–∞–Ω—ñ (–∑ —Å–∞–π—Ç—É)
    data = {
        '–†—ñ–∫': ['2017', '2018', '2019', '2020', '2021', '2022', '2023', '2024', '2025'],
        '–£—á–∞—Å–Ω–∏–∫–∏': [58, 76, 129, 136, 169, 145, 100, 58, 139]
    }
    df = pd.DataFrame(data)
    
    # –ë—É–¥—É—î–º–æ –≥–∞—Ä–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫
    st.bar_chart(df.set_index('–†—ñ–∫'))
    
    st.markdown("""
    * **2017 —Ä—ñ–∫:** –ü–µ—Ä—à–∞ –æ–ª—ñ–º–ø—ñ–∞–¥–∞.
    * **2021 —Ä—ñ–∫:** –†–µ–∫–æ—Ä–¥–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —É—á–∞—Å–Ω–∏–∫—ñ–≤ (169).
    * –ì–µ–æ–≥—Ä–∞—Ñ—ñ—è —É—á–∞—Å–Ω–∏–∫—ñ–≤ –ø–æ—Å—Ç—ñ–π–Ω–æ —Ä–æ–∑—à–∏—Ä—é—î—Ç—å—Å—è, –æ—Ö–æ–ø–ª—é—é—á–∏ –¥–æ 7 –∫—Ä–∞—ó–Ω.
    """)

elif page == "–ö–æ–Ω—Ç–∞–∫—Ç–∏":
    st.title("üì¨ –ö–æ–Ω—Ç–∞–∫—Ç–∏")
    
    st.markdown("""
    –ì–µ–æ–º–µ—Ç—Ä–∏—á–Ω–∞ –æ–ª—ñ–º–ø—ñ–∞–¥–∞ —ñ–º–µ–Ω—ñ –í'—è—á–µ—Å–ª–∞–≤–∞ –Ø—Å—ñ–Ω—Å—å–∫–æ–≥–æ –∑–∞–ø—Ä–æ—à—É—î –¥–æ —Å–ø—ñ–≤–ø—Ä–∞—Ü—ñ –º–∞—Ç–µ–º–∞—Ç–∏–∫—ñ–≤ —Ç–∞ –ø–µ–¥–∞–≥–æ–≥—ñ–≤.
    
    –Ø–∫—â–æ —É –≤–∞—Å —î –∑–∞–ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∞–≤—Ç–æ—Ä—Å—å–∫—ñ –∑–∞–¥–∞—á—ñ), –ø–∏—à—ñ—Ç—å –Ω–∞–º:
    """)
    
    st.info("üìß **Email:** yasinskyi.geometry.olympiad@gmail.com")
    
    st.write("–ú–∏ –∑–∞–≤–∂–¥–∏ –≤—ñ–¥–∫—Ä–∏—Ç—ñ –¥–æ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è!")
